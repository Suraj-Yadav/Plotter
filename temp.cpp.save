#include <SFML/Graphics.hpp>
#include <iostream>
#include <cmath>
#include "Expression.h"
#include "Button.h"
#include "TextBox.h"
#include "gridFunc.h"
#define val(x) std::cout<<#x"="<<x<<"\n"
#define show(y,x) std::cout<<y"="<<x<<"\n"
#define deb std::cout<<__LINE__<<"\n"
#define debf std::cout<<__FILE__<<","<<__LINE__<<"\n"
sf::Font font;
sf::Text text;
const float zoomAmount = 1.1f;
int main() {
	bool change = true;
	// Create the main window
	std::string str1 = "x*sin(x)";
	std::string str2 = "sin(x)";
	std::string str3 = "cos(x)";
	std::string str4 = "sin(x)/cos(x)";
//	std::cin >> str;
	text.setFont(font);
	text.setColor(sf::Color::Blue);
	text.setCharacterSize(7.5);
	sf::RenderWindow window(sf::VideoMode(800, 600), "Plotter");
	sf::View graphView(sf::Vector2f(0, 0.5), sf::Vector2f(8, 6));
	sf::View uiView = window.getDefaultView();
	window.setView(graphView);
	Expression e1(str1), e2(str2), e3(str3), e4(str4);
//	e.print();
	// Create a graphical text to display
	if(!font.loadFromFile("C:/Windows/Fonts/arial.ttf"))
		return EXIT_FAILURE;
	// Start the game loop
	sf::Clock clock;
	bool draging = false;
	sf::Vector2u origSize(window.getSize());
	sf::Vector2f beforeCoord;
	while(window.isOpen()) {
		// Process events
		sf::Event event;
		while(window.pollEvent(event)) {
			// Close window: exit
//			deb;
			if(event.type == sf::Event::Closed)
				window.close();
			else if(event.type == sf::Event::KeyPressed && event.key.code == sf::Keyboard::Escape)
				window.close();
			else if(event.type == sf::Event::MouseWheelMoved) {
				if(event.mouseWheel.delta > 0)
					zoomViewAt({ event.mouseWheel.x, event.mouseWheel.y }, window, (1.f / zoomAmount), false);
				else
					zoomViewAt({ event.mouseWheel.x, event.mouseWheel.y }, window, zoomAmount, false);
				change = true;
				graphView = window.getView();
			}
			else if(event.type == sf::Event::MouseButtonPressed) {
				draging = true;
				beforeCoord = window.mapPixelToCoords(sf::Mouse::getPosition(window));
				change = true;
			}
			else if(event.type == sf::Event::MouseButtonReleased) {
				draging = false;
				change = true;
			}
			else if(event.type == sf::Event::Resized) {
//				std::cout << "Resized\n";
				sf::Vector2u newSize(window.getSize());
				// update the view to the new size of the window
				graphView = window.getView();
				graphView.setSize(newSize.x * graphView.getSize().x / origSize.x, newSize.y * graphView.getSize().y / origSize.y);
				window.setView(graphView);
				origSize = newSize;
				uiView.setSize(window.getSize().x, window.getSize().y);
				uiView.setCenter(window.getSize().x / 2.0, window.getSize().y / 2.0);
				//change = true;
				//				std::cout<<currentView.getCenter().x<<","<<currentView.getCenter().y<<"\n";
				//				std::cout<<currentView.getSize().x<<","<<currentView.getSize().y<<"\n";
			}
		}
		// Clear screen
		window.clear(sf::Color::White);
		graphView = window.getView();
		// Draw the string
		if(draging) {
			sf::Vector2f newCoord(window.mapPixelToCoords(sf::Mouse::getPosition(window)));
			sf::Vector2f offset = beforeCoord - newCoord;
			graphView = window.getView();
			graphView.move(offset);
			window.setView(graphView);
		}
//		debf;
		//Draw the Graph and Things
//        e1.assign(entry.getString());
		drawGrid(window, change);
		plotYvsX(e1, window);
		plotYvsX(e2, window);
		plotYvsX(e3, window);
		plotYvsX(e4, window);
		//Draw the UI and Stuff
		window.setView(uiView);
		//Restore the view
		window.setView(graphView);
		// Update the window
		window.display();
//		std::cin>>str2;
		//window.close();
	}
	return EXIT_SUCCESS;
}
